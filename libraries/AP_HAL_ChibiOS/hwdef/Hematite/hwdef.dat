# Rhombus-Labs Hematite CAN node

env AP_PERIPH 1
env ROMFS_UNCOMPRESSED True

APJ_BOARD_ID 1478

MCU STM32L431 STM32L431xx
OSCILLATOR_HZ 8000000
FLASH_RESERVE_START_KB 40
FLASH_SIZE_KB 256
STORAGE_FLASH_PAGE 18
MAIN_STACK 0x300
PROCESS_STACK 0xA00
STDOUT_SERIAL SD1
STDOUT_BAUDRATE 57600

define DMA_RESERVE_SIZE 0
define SERIAL_BUFFERS_SIZE 512
define PORT_INT_REQUIRED_STACK 64
define AP_GPS_NMEA_ENABLED 1
define AP_PARAM_MAX_EMBEDDED_PARAM 512
define AP_PERIPH_MSP_PORT_DEFAULT 1
define HAL_STORAGE_SIZE 800
define HAL_NO_GPIO_IRQ
define HAL_USE_ADC FALSE
define HAL_RCIN_THREAD_ENABLED 0
define HAL_NO_RCOUT_THREAD
define HAL_NO_TIMER_THREAD
define HAL_PERIPH_GPS_PORT_DEFAULT 2
define HAL_PERIPH_LISTEN_FOR_SERIAL_UART_REBOOT_CMD_PORT 0

# define HAL_PERIPH_ENABLE_GPS
# define HAL_PERIPH_ENABLE_MAG
# define HAL_PERIPH_ENABLE_MSP

define AP_PERIPH_GPS_ENABLED 1
define AP_PERIPH_MAG_ENABLED 1
define AP_PERIPH_MSP_ENABLED 1

define HAL_PROBE_EXTERNAL_I2C_COMPASSES
define HAL_COMPASS_MAX_SENSORS 1

define HAL_MSP_ENABLED 1
define GPS_MAX_RATE_MS 200
define GPS_MAX_RECEIVERS 1
define GPS_MAX_INSTANCES 1
define GPS_MOVING_BASELINE 1


# System Timer
STM32_ST_USE_TIMER 15
define CH_CFG_ST_RESOLUTION 16

# SWD
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# LED
PB3 LED OUTPUT HIGH
define HAL_LED_ON 1

# SPI
PA5 SPI1_SCK SPI1
PB4 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1
PA4 MAG_CS CS
PB2 SPARE_CS CS

SPIDEV  rm3100 SPI1 DEVID1   MAG_CS MODE0  1*MHZ  1*MHZ
COMPASS RM3100 SPI:rm3100 false ROTATION_PITCH_180

# I2C
I2C_ORDER I2C2

PB13 I2C2_SCL I2C2
PB14 I2C2_SDA I2C2

COMPASS QMC5883L I2C:0:0xd false ROTATION_PITCH_180_YAW_90

define HAL_I2C_CLEAR_ON_TIMEOUT 0
define HAL_I2C_INTERNAL_MASK 1

# CAN
CAN_ORDER 1

PB8 CAN1_RX CAN1
PB9 CAN1_TX CAN1

define HAL_CAN_POOL_SIZE 12000

# UARTs
SERIAL_ORDER EMPTY USART2 USART3

# USART1
PB6 USART1_TX USART1 SPEED_HIGH
PB7 USART1_RX USART1 SPEED_HIGH
undef PB6
undef PB7

# USART2
PA2 USART2_TX USART2 SPEED_HIGH
PA3 USART2_RX USART2 SPEED_HIGH

# USART3
PB10 USART3_TX USART3 SPEED_HIGH
PB11 USART3_RX USART3 SPEED_HIGH
